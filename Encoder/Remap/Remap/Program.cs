using System;
using System.IO;

namespace Remap
{
    class Program
    {
        static int[] MapMatrix =
        {
            50,49,48,47,46,23,22,1,151,190,191,230,231,331,330,291,290,251,351,372,373,396,397,398,399,400,
            51,52,53,54,45,24,21,2,152,189,192,229,232,332,329,292,289,252,352,371,374,395,404,403,402,401,
            58,57,56,55,44,25,20,3,153,188,193,228,233,333,328,293,288,253,353,370,375,394,405,406,407,408,
            59,60,61,62,43,26,19,4,154,187,194,227,234,334,327,294,287,254,354,369,376,393,412,411,410,409,
            66,65,64,63,42,27,18,5,155,186,195,226,235,335,326,295,286,255,355,368,377,392,413,414,415,416,
            67,68,69,70,41,28,17,6,156,185,196,225,236,336,325,296,285,256,356,367,378,391,420,419,418,417,
            74,73,72,71,40,29,16,7,157,184,197,224,237,337,324,297,284,257,357,366,379,390,421,422,423,424,
            75,76,77,78,39,30,15,8,158,183,198,223,238,338,323,298,283,258,358,365,380,389,428,427,426,425,
            82,81,80,79,38,31,14,9,159,182,199,222,239,339,322,299,282,259,359,364,381,388,429,430,431,432,
            83,84,85,86,37,32,13,10,160,181,200,221,240,340,321,300,281,260,360,363,382,387,436,435,434,433,
            90,89,88,87,36,33,12,11,161,180,201,220,241,341,320,301,280,261,361,362,383,386,437,438,439,440,
            91,92,93,94,35,34,-1,-1,162,179,202,219,242,342,319,302,279,262,-1,-1,384,385,444,443,442,441,
            98,97,96,95,-1,-1,-1,-1,163,178,203,218,243,343,318,303,278,263,-1,-1,-1,-1,445,446,447,448,
            99,100,101,102,-1,-1,-1,-1,164,177,204,217,244,344,317,304,277,264,-1,-1,-1,-1,452,451,450,449,
            106,105,104,103,132,133,144,145,165,176,205,216,245,345,316,305,276,265,495,494,483,482,453,454,455,456,
            107,108,109,110,131,134,143,146,166,175,206,215,246,346,315,306,275,266,496,493,484,481,460,459,458,457,
            114,113,112,111,130,135,142,147,167,174,207,214,247,347,314,307,274,267,497,492,485,480,461,462,463,464,
            115,116,117,118,129,136,141,148,168,173,208,213,248,348,313,308,273,268,498,491,486,479,468,467,466,465,
            122,121,120,119,128,137,140,149,169,172,209,212,249,349,312,309,272,269,499,490,487,478,469,470,471,472,
            123,124,125,126,127,138,139,150,170,171,210,211,250,350,311,310,271,270,500,489,488,477,476,475,474,473
        };

        static void RemapAnimation(string file)
        {
            byte[] inFrame = null;
            byte[] outFRame = new byte[3*500];
            string outFile = file + ".n";
            FileStream fsIn = new FileStream(file, FileMode.Open, FileAccess.Read);
            FileStream fsOut = new FileStream(outFile, FileMode.Create, FileAccess.Write);
            BinaryReader brIn = new BinaryReader(fsIn);
            BinaryWriter brOut = new BinaryWriter(fsOut);
            int frames = (int)brIn.BaseStream.Length / (3 * 26 * 20);
            Console.WriteLine("Frame:{0}", frames);
            if ((int)brIn.BaseStream.Length % (3 * 26 * 20) != 0)
            {
                Console.WriteLine("Not evenFrame count?");
            }

            for(int j = 0; j < frames;j++)
            {
                inFrame = brIn.ReadBytes(26 * 20 * 3);
                for (int i = 0; i < 26 * 20; i++)
                {
                    int pixel = MapMatrix[i]-1;
                    if (pixel >=0)
                    {
                        outFRame[pixel * 3] = inFrame[i * 3];
                        outFRame[(pixel * 3) + 1] = inFrame[(i * 3) + 1];
                        outFRame[(pixel * 3) + 2] = inFrame[(i * 3) + 2];
                    }
                }
                brOut.Write(outFRame, 0, outFRame.Length);
                Console.WriteLine("Frame:{0} Encoded",j);
            }
            brOut.Close();
        }

        static void Main(string[] args)
        {
            Console.WriteLine("Hello World!");
            string folderPath = args[0];
            if (Directory.Exists(folderPath))
                Console.WriteLine("Folder Exists:" + folderPath);

            foreach (string file in Directory.EnumerateFiles(folderPath, "*.dat"))
            {
                Console.WriteLine("Encoding File:"+file);
                RemapAnimation(file);
                Console.WriteLine("Done!");
            }
        }
    }
}
